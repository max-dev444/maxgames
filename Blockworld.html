<!DOCTYPE html>
<html>
<head>
<title>Global Block Builder</title>
<style>
body {
    margin:0;
    overflow:hidden;
    background:#111;
    color:white;
    font-family: monospace;
}

#ui {
    position:fixed;
    right:10px;
    top:10px;
    background:#222;
    padding:10px;
    border-radius:8px;
    z-index:10;
}

#color {
    width:50px;
    height:50px;
    border:none;
}

#deleteToggle {
    margin-top:10px;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui">
    Block Color:<br>
    <input type="color" id="color" value="#ffffff"><br>
    <label>
        <input type="checkbox" id="deleteToggle"> Delete Mode
    </label>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBI7jbEgrN-z7SUx7moImNTDA10B-q8fuw",
  authDomain: "blockworld-e9b9d.firebaseapp.com",
  databaseURL: "https://blockworld-e9b9d-default-rtdb.firebaseio.com",
  projectId: "blockworld-e9b9d",
  storageBucket: "blockworld-e9b9d.firebasestorage.app",
  messagingSenderId: "915723982814",
  appId: "1:915723982814:web:95b24f6272e63facdcaf4f",
  measurementId: "G-C7K68ZWPWZ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const blocksRef = db.ref("blocks");

const GRID_SIZE = 1024;
const CELL = 32;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let camX = 0;
let camY = 0;
const blocks = {};

blocksRef.on("child_added", snap => blocks[snap.key] = snap.val());
blocksRef.on("child_changed", snap => blocks[snap.key] = snap.val());
blocksRef.on("child_removed", snap => delete blocks[snap.key]);

function draw(){
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let startX = Math.floor(camX / CELL);
    let startY = Math.floor(camY / CELL);
    let endX = startX + Math.ceil(canvas.width / CELL);
    let endY = startY + Math.ceil(canvas.height / CELL);

    for(let x=startX; x<=endX; x++){
        for(let y=startY; y<=endY; y++){
            if(x<0||y<0||x>=GRID_SIZE||y>=GRID_SIZE) continue;

            let px = x*CELL - camX;
            let py = y*CELL - camY;

            ctx.strokeStyle = "#222";
            ctx.strokeRect(px,py,CELL,CELL);

            const key = x+"_"+y;
            if(blocks[key]){
                ctx.fillStyle = blocks[key];
                ctx.fillRect(px,py,CELL,CELL);
            }
        }
    }
    requestAnimationFrame(draw);
}
draw();

document.addEventListener("keydown", e=>{
    if(e.key==="ArrowLeft") camX -= CELL*5;
    if(e.key==="ArrowRight") camX += CELL*5;
    if(e.key==="ArrowUp") camY -= CELL*5;
    if(e.key==="ArrowDown") camY += CELL*5;

    camX = Math.max(0, Math.min(camX, GRID_SIZE*CELL - canvas.width));
    camY = Math.max(0, Math.min(camY, GRID_SIZE*CELL - canvas.height));
});

// New features
let isDragging = false;
const deleteToggle = document.getElementById("deleteToggle");

function placeOrDeleteBlock(e){
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left + camX;
    const my = e.clientY - rect.top + camY;

    const gx = Math.floor(mx / CELL);
    const gy = Math.floor(my / CELL);
    if(gx<0||gy<0||gx>=GRID_SIZE||gy>=GRID_SIZE) return;

    const key = gx+"_"+gy;

    if(deleteToggle.checked){
        blocksRef.child(key).remove(); // delete block
    } else {
        const color = document.getElementById("color").value;
        blocksRef.child(key).set(color); // place block
    }
}

canvas.addEventListener("mousedown", e => {
    isDragging = true;
    placeOrDeleteBlock(e);
});

canvas.addEventListener("mouseup", e => isDragging = false);
canvas.addEventListener("mouseleave", e => isDragging = false);

canvas.addEventListener("mousemove", e => {
    if(isDragging){
        placeOrDeleteBlock(e);
    }
});

canvas.addEventListener("click", e => {
    // single click still works
    placeOrDeleteBlock(e);
});
</script>

</body>
</html>
