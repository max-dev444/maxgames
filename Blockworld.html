<!DOCTYPE html>
<html>
<head>
<title>Global Block Builder</title>
<style>
body {
    margin:0;
    overflow:hidden;
    background:#111;
    color:white;
    font-family: monospace;
}

#ui {
    position:fixed;
    right:10px;
    top:10px;
    background:#222;
    padding:10px;
    border-radius:8px;
    z-index:10;
}

#color {
    width:50px;
    height:50px;
    border:none;
}

#deleteToggle{
    width:100%;
    margin-top:6px;
    background:#ff4444;
    color:black;
    border:none;
    padding:6px;
    cursor:pointer;
}

#sidebar{
    position:fixed;
    right:0;
    top:0;
    width:320px;
    height:100%;
    background:#111;
    border-left:3px solid #ff4444;
    padding:12px;
    display:none;
    z-index:20;
    overflow-y:auto;
}

#closeSide{
    position:absolute;
    right:10px;
    top:10px;
    background:#ff4444;
    border:none;
    color:black;
    font-size:18px;
    cursor:pointer;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui">
    Block Color:<br>
    <input type="color" id="color" value="#ffffff">
    <button id="deleteToggle">Delete Mode: OFF</button>
</div>

<div id="sidebar">
    <button id="closeSide">X</button>
    <div id="blockInfo"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBI7jbEgrN-z7SUx7moImNTDA10B-q8fuw",
  authDomain: "blockworld-e9b9d.firebaseapp.com",
  databaseURL: "https://blockworld-e9b9d-default-rtdb.firebaseio.com",
  projectId: "blockworld-e9b9d",
  storageBucket: "blockworld-e9b9d.firebasestorage.app",
  messagingSenderId: "915723982814",
  appId: "1:915723982814:web:95b24f6272e63facdcaf4f"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const blocksRef = db.ref("blocks");

const GRID_SIZE = 1024;
const CELL = 32;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

let camX=0, camY=0;
const blocks={};

blocksRef.on("value",snap=>{
    Object.assign(blocks,snap.val()||{});
});

// --- GEO LOCATION ---
let myLocation="Unknown";
let myName="UnknownPlayer";
fetch("https://ipapi.co/json/")
.then(r=>r.json())
.then(d=>{
    myLocation=d.region || d.country_name;
    myName=myLocation.replace(/ /g,"")+"Player";
});

// --- DRAW ---
function draw(){
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let startX=Math.floor(camX/CELL);
    let startY=Math.floor(camY/CELL);

    for(let x=startX;x<startX+50;x++){
        for(let y=startY;y<startY+30;y++){
            if(x<0||y<0||x>=GRID_SIZE||y>=GRID_SIZE) continue;

            let px=x*CELL-camX;
            let py=y*CELL-camY;

            ctx.strokeStyle="#222";
            ctx.strokeRect(px,py,CELL,CELL);

            let key=x+"_"+y;
            if(blocks[key]?.color){
                ctx.fillStyle=blocks[key].color;
                ctx.fillRect(px,py,CELL,CELL);
            }
        }
    }
    requestAnimationFrame(draw);
}
draw();

// --- CAMERA ---
document.onkeydown=e=>{
    if(e.key==="ArrowLeft") camX-=CELL*5;
    if(e.key==="ArrowRight") camX+=CELL*5;
    if(e.key==="ArrowUp") camY-=CELL*5;
    if(e.key==="ArrowDown") camY+=CELL*5;
};

// --- DELETE MODE ---
let deleteMode=false;
deleteToggle.onclick=()=>{
    deleteMode=!deleteMode;
    deleteToggle.textContent="Delete Mode: "+(deleteMode?"ON":"OFF");
};

// --- HISTORY SAVE ---
function writeBlock(key,color,deleted=false){
    blocksRef.child(key).once("value").then(s=>{
        let h=s.val()?.history||[];
        h.push({
            color:color,
            deleted:deleted,
            time:new Date().toLocaleString(),
            location:myLocation
        });
        blocksRef.child(key).set({
            color:deleted?null:color,
            history:h
        });
    });
}

// --- DRAG BUILD ---
let dragging=false;
canvas.onmousedown=()=>dragging=true;
canvas.onmouseup=()=>dragging=false;

canvas.onmousemove=e=>{
    if(!dragging) return;
    place(e);
};

canvas.onclick=e=>place(e);

function place(e){
    const rect=canvas.getBoundingClientRect();
    const gx=Math.floor((e.clientX-rect.left+camX)/CELL);
    const gy=Math.floor((e.clientY-rect.top+camY)/CELL);
    const key=gx+"_"+gy;
    if(deleteMode){
        if(blocks[key]) writeBlock(key,blocks[key].color,true);
    }else{
        writeBlock(key,color.value,false);
    }
}

// --- SIDEBAR ---
canvas.oncontextmenu=e=>{
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const gx=Math.floor((e.clientX-rect.left+camX)/CELL);
    const gy=Math.floor((e.clientY-rect.top+camY)/CELL);
    const key=gx+"_"+gy;
    if(!blocks[key]) return;

    sidebar.style.display="block";
    ui.style.display="none";

    blockInfo.innerHTML="<h3>Block "+key+"</h3>";
    blocks[key].history.forEach(h=>{
        blockInfo.innerHTML+=`
        <div style="border-bottom:1px solid #333;margin-bottom:8px;">
        ${h.deleted?"Deleted":"Placed"}<br>
        Color: ${h.color}<br>
        Location: ${h.location}<br>
        Time: ${h.time}
        </div>`;
    });
};

closeSide.onclick=()=>{
    sidebar.style.display="none";
    ui.style.display="block";
};
</script>

</body>
</html>
