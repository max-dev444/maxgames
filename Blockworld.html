<!DOCTYPE html>
<html>
<head>
<title>Global Block Builder</title>
<style>
body {
    margin:0;
    overflow:hidden;
    background:#111;
    color:white;
    font-family: monospace;
}

#ui {
    position:fixed;
    right:10px;
    top:10px;
    background:#222;
    padding:10px;
    border-radius:8px;
    z-index:10;
}

#color { width:50px; height:50px; border:none; margin-bottom:5px; }
#deleteMode { display:block; margin-bottom:5px; }

#sidebar {
    position:fixed;
    right:0;
    top:0;
    width:250px;
    height:100%;
    background:#111;
    overflow-y:auto;
    padding:10px;
    display:none;
    z-index:9;
}

#sidebar h2 { margin-top:0; display:flex; justify-content:space-between; }
#sidebar button { background:#444; color:white; border:none; border-radius:5px; cursor:pointer; }

#playersList {
    position:fixed;
    left:0;
    top:0;
    width:200px;
    height:100%;
    background:#111;
    overflow-y:auto;
    padding:10px;
    z-index:9;
}
#playersList h2 { margin-top:0; }

canvas { display:block; }

</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui">
    Block Color:<br>
    <input type="color" id="color" value="#ffffff"><br>
    <label><input type="checkbox" id="deleteMode"> Delete Mode</label>
</div>

<div id="sidebar">
    <h2>Block Info <button id="closeSidebar">X</button></h2>
    <div id="blockInfo"></div>
</div>

<div id="playersList">
    <h2>Players</h2>
    <ul id="players"></ul>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBI7jbEgrN-z7SUx7moImNTDA10B-q8fuw",
  authDomain: "blockworld-e9b9d.firebaseapp.com",
  databaseURL: "https://blockworld-e9b9d-default-rtdb.firebaseio.com",
  projectId: "blockworld-e9b9d",
  storageBucket: "blockworld-e9b9d.firebasestorage.app",
  messagingSenderId: "915723982814",
  appId: "1:915723982814:web:95b24f6272e63facdcaf4f",
  measurementId: "G-C7K68ZWPWZ"
}
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const blocksRef = db.ref("blocks");
const playersRef = db.ref("players");

// Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const GRID_SIZE = 1024;
const CELL = 32;
let camX=0, camY=0;
const blocks={};

// UI
const colorPicker = document.getElementById("color");
const deleteToggle = document.getElementById("deleteMode");
const sidebar = document.getElementById("sidebar");
const blockInfoDiv = document.getElementById("blockInfo");
const closeSidebarBtn = document.getElementById("closeSidebar");
const playersList = document.getElementById("players");

// Player info
let playerName = "Player_"+Math.floor(Math.random()*1000000);
let playerCountry = "Unknown";

// Get player country
fetch("https://ipapi.co/json/").then(r=>r.json()).then(data=>{
    playerCountry = data.country_name;
});

// Add player to list
const playerRef = playersRef.child(playerName);
playerRef.set({country:playerCountry});
playerRef.onDisconnect().remove();

// Update live players list
playersRef.on("value", snap=>{
    playersList.innerHTML = "<h2>Players</h2><ul>" + 
        Object.keys(snap.val()||{}).map(p=>" <li>"+p+"</li>").join("") +
        "</ul>";
});

// Sync blocks
blocksRef.on("child_added", snap=>{blocks[snap.key]=snap.val();});
blocksRef.on("child_changed", snap=>{blocks[snap.key]=snap.val();});
blocksRef.on("child_removed", snap=>{delete blocks[snap.key];});

// Draw
function draw(){
    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let startX=Math.floor(camX/CELL);
    let startY=Math.floor(camY/CELL);
    let endX=startX+Math.ceil(canvas.width/CELL);
    let endY=startY+Math.ceil(canvas.height/CELL);

    for(let x=startX;x<=endX;x++){
        for(let y=startY;y<=endY;y++){
            if(x<0||y<0||x>=GRID_SIZE||y>=GRID_SIZE) continue;
            let px = x*CELL-camX;
            let py = y*CELL-camY;
            ctx.strokeStyle="#222";
            ctx.strokeRect(px,py,CELL,CELL);

            let key=x+"_"+y;
            if(blocks[key] && blocks[key].history && blocks[key].history.length){
                ctx.fillStyle=blocks[key].history[blocks[key].history.length-1].color;
                ctx.fillRect(px,py,CELL,CELL);
            }
        }
    }

    requestAnimationFrame(draw);
}
draw();

// Camera movement
document.addEventListener("keydown", e=>{
    if(e.key==="ArrowLeft") camX-=CELL*5;
    if(e.key==="ArrowRight") camX+=CELL*5;
    if(e.key==="ArrowUp") camY-=CELL*5;
    if(e.key==="ArrowDown") camY+=CELL*5;
    camX=Math.max(0, Math.min(camX, GRID_SIZE*CELL - canvas.width));
    camY=Math.max(0, Math.min(camY, GRID_SIZE*CELL - canvas.height));
});

// Right-click info
canvas.addEventListener("contextmenu", e=>{
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const gx = Math.floor((e.clientX-rect.left+camX)/CELL);
    const gy = Math.floor((e.clientY-rect.top+camY)/CELL);
    const key = gx+"_"+gy;
    if(blocks[key] && blocks[key].history){
        sidebar.style.display="block";
        blockInfoDiv.innerHTML = "<b>Block "+key+"</b><br>";
        blocks[key].history.forEach((h,i)=>{
            blockInfoDiv.innerHTML += (i+1)+". "+(h.deleted?"Deleted":"Placed")+
                " | "+h.color+" | "+h.country+" | "+h.time+"<br>";
        });
    }
});

closeSidebarBtn.onclick = ()=>{ sidebar.style.display="none"; };

// Place/Delete/Drag
let isDragging=false;

function updateBlock(x,y,color,deleted=false){
    const key = x+"_"+y;
    const timestamp = new Date().toLocaleString();
    const historyEntry = {color,color, country:playerCountry, time:timestamp, deleted};
    if(!blocks[key]) blocks[key]={history:[]};
    blocks[key].history.push(historyEntry);
    blocksRef.child(key).set(blocks[key]);
}

canvas.addEventListener("mousedown", e=>{
    if(e.button!==0) return;
    isDragging=true;
    handleBlockPlacement(e);
});
canvas.addEventListener("mouseup", e=>{isDragging=false;});
canvas.addEventListener("mousemove", e=>{ if(isDragging) handleBlockPlacement(e); });

function handleBlockPlacement(e){
    const rect = canvas.getBoundingClientRect();
    const gx = Math.floor((e.clientX-rect.left+camX)/CELL);
    const gy = Math.floor((e.clientY-rect.top+camY)/CELL);
    if(gx<0||gy<0||gx>=GRID_SIZE||gy>=GRID_SIZE) return;

    if(deleteToggle.checked){
        updateBlock(gx,gy,"#000",true);
    } else {
        updateBlock(gx,gy,colorPicker.value,false);
    }
}
</script>

</body>
</html>
